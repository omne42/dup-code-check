name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-binaries:
    name: Build binaries (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build (release)
        run: cargo build --release -p dup-code-check

      - name: Package (tar.gz)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          bin_name="dup-code-check"
          os="$(uname -s | tr '[:upper:]' '[:lower:]')"
          if [[ "$os" == "darwin" ]]; then os="macos"; fi
          arch="$(uname -m)"
          case "$arch" in
            x86_64) arch="x64" ;;
            aarch64|arm64) arch="arm64" ;;
          esac

          asset="dup-code-check-${os}-${arch}.tar.gz"
          tar -C target/release -czf "dist/${asset}" "${bin_name}"
          (
            cd dist
            shasum -a 256 "${asset}" | awk '{print $1 "  " $2}' >"${asset}.sha256"
          )

      - name: Package (zip)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $os = "windows"
          $arch = $env:RUNNER_ARCH.ToLower()
          if ($arch -eq "x64") { $arch = "x64" }
          elseif ($arch -eq "arm64") { $arch = "arm64" }
          $asset = "dup-code-check-$os-$arch.zip"
          $exe = "target\\release\\dup-code-check.exe"
          Compress-Archive -Path $exe -DestinationPath ("dist\\" + $asset) -Force
          $hash = (Get-FileHash ("dist\\" + $asset) -Algorithm SHA256).Hash.ToLower()
          "$hash  $asset" | Out-File -Encoding utf8NoBOM ("dist\\" + $asset + ".sha256")

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-${{ matrix.os }}
          path: dist/*

  publish:
    name: Publish (GitHub Release + npm)
    needs: build-binaries
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-assets-*
          merge-multiple: true
          path: dist

      - name: Create SHA256SUMS.txt
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          ls -la
          cat *.sha256 >SHA256SUMS.txt

      - name: Create GitHub release (attach binaries)
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*
          generate_release_notes: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org

      - name: Verify tag matches package version
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          version="${tag#v}"
          pkg_version="$(node -p "require('./package.json').version")"
          if [[ "$version" != "$pkg_version" ]]; then
            echo "Tag version ($version) does not match package.json version ($pkg_version)" >&2
            exit 1
          fi

      - name: Verify tag matches Rust package version
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          version="${tag#v}"
          rust_version="$(cargo metadata --no-deps --format-version 1 | python3 -c 'import json,sys; m=json.load(sys.stdin); print(next(p["version"] for p in m["packages"] if p["name"]=="dup-code-check"))')"
          if [[ "$version" != "$rust_version" ]]; then
            echo "Tag version ($version) does not match Rust package version ($rust_version)" >&2
            exit 1
          fi

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${CARGO_REGISTRY_TOKEN:-}" ]]; then
            echo "Skipping crates.io publish (CARGO_REGISTRY_TOKEN is not set)."
            exit 0
          fi
          cargo publish -p dup-code-check-core
          # crates.io index can take some time to update after publishing the core crate.
          # Retry the CLI publish a few times to avoid flaky releases.
          for attempt in 1 2 3 4 5 6; do
            if cargo publish -p dup-code-check; then
              exit 0
            fi
            echo "dup-code-check publish failed (attempt ${attempt}); retrying in 15s..." >&2
            sleep 15
          done
          echo "dup-code-check publish still failing after retries." >&2
          exit 1

      - name: Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${NODE_AUTH_TOKEN:-}" ]]; then
            echo "Skipping npm publish (NPM_TOKEN is not set)."
            exit 0
          fi
          npm publish --access public
